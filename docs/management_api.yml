openapi: 3.0.3

info:
  title: Reporting
  description: |
    Management API for the reporting service.
  version: "1"

servers:
  - url: https://hosted.mender.io/api/management/v1/reporting

security:
  - ManagementJWT: []

paths:
  /devices/aggregate:
    post:
      tags:
        - Management API
      summary: Aggregate device inventory data.
      operationId: Aggregate
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AggregationTerms'
            example:
              aggregations:
                - name: "group"
                  attribute: "group_name"
                  scope: "system"
                  size: 10
              filters:
                - attribute: "SN"
                  scope: "inventory"
                  type: "$in"
                  value: ["1234567890", "0987654321"]
      responses:
        200:
          description: OK. Returns a list of aggregations.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Aggregation'
              example:
                - name: "group"
                  items:
                  - key: "group1"
                    count: 1
                  - key: "group1"
                    count: 2
                  other_count: 5
        400:
          $ref: '#/components/responses/InvalidRequestError'
        500:
          $ref: '#/components/responses/InternalServerError'

  /devices/attributes:
    get:
      tags:
        - Management API
      operationId: Get device filterable attributes usage and limits
      summary: Get the list of device filterable attributes and the limits
      description:  |
        Returns a list of device filterable attributes.
      responses:
        200:
          description: OK. Returns a list of filterable attributes.
          content:
            application/json:
              schema:
                title: Attributes usage and limits
                type: object
                properties:
                  attributes:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                          description: Attribute key to compare.
                        scope:
                          type: string
                          description: The scope the attribute exists in.
                    description: List of filterable attributes
                  count:
                    type: integer
                    description: Current number of device filterable attributes
                  limit:
                    type: integer
                    description: Maximum number of device filterable attributes
                example:
                  attributes:
                    - name: "system-version"
                      scope: "inventory"
                    - name: "SN"
                      scope: "inventory"
                  count: 2
                  limit: 100
        500:
          $ref: '#/components/responses/InternalServerError'

  /devices/search:
    post:
      tags:
        - Management API
      summary: Search device inventory data.
      operationId: Search
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchTerms'
            example:
              page: 1
              per_page: 20
              filters:
                - attribute: "SN"
                  scope: "inventory"
                  type: "$in"
                  value: ["1234567890", "0987654321"]
              sort:
                - attribute: "system-version"
                  scope: "inventory"
                  order: "asc"
              attributes:
                - attribute: "SN"
                  scope: "inventory"
              device_ids:
                - "571223e6-26d8-4aae-9074-0d12ce710596"
                - "79b29122-7b69-4548-8b72-73139f44eaba"
                - "ed15eec1-5add-495d-9a3c-119dafe85e4c"
                - "b8783fed-103f-4416-b935-3dd1180640c6"
                - "8e5372bc-b28c-4df4-8de2-9fea92e62db3"

      responses:
        200:
          description: OK. Returns a paginated list of devices.
          headers:
            X-Total-Count:
              schema:
                type: integer
                example: 12300
              description: >-
                The total number of matches.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DeviceInventory'
              example:
                - id: "571223e6-26d8-4aae-9074-0d12ce710596"
                  attributes:
                    - name: "SN"
                      value: "1234567890"
                      scope: "inventory"
                  updated_ts: "2021-08-19T10:25:32Z"
                - id: "79b29122-7b69-4548-8b72-73139f44eaba"
                  attributes:
                    - name: "SN"
                      value: "0987654321"
                      scope: "inventory"
                  updated_ts: "2021-08-19T08:03:32Z"
        400:
          $ref: '#/components/responses/InvalidRequestError'
        500:
          $ref: '#/components/responses/InternalServerError'

  /devices/search/attributes:
    get:
      tags:
        - Management API
      operationId: Get device filterable attributes
      summary: Get the list of device filterable attributes
      description:  |
        Returns a list of device filterable attributes.
      responses:
        200:
          description: OK. Returns a list of filterable attributes.
          content:
            application/json:
              schema:
                title: List of filter attributes
                type: array
                items:
                  $ref: '#/components/schemas/FilterAttribute'
              example:
                - name: "serial_no"
                  scope: "inventory"
                  count: 1
                - name: "region"
                  scope: "inventory"
                  count: 1
        500:
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    ManagementJWT:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token issued by 'POST /api/management/v1/useradm/auth/login'

        The JWT can be alternatively passed as a cookie named "JWT".

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Description of the error.
        request_id:
          type: string
          description: >-
            Request ID passed with the request X-MEN-RequestID header
            or generated by the server.
      description: Error descriptor.
      example:
        error: "<error description>"
        request_id: "eed14d55-d996-42cd-8248-e806663810a8"

    AggregationTerm:
      type: object
      properties:
        name:
          type: string
          description: Name of the aggregation.
        attribute:
          type: string
          description: Attribute key(s) to aggregate.
        scope:
          type: string
          description: The scope the attribute(s) exists in.
        limit:
          type: integer
          description: Number of top results to return.
          default: 10
        aggregations:
          type: array
          minItems: 1
          maxItems: 100
          items:
            $ref: '#/components/schemas/AggregationTerm'
          description: Sub-aggregation terms.
      required:
        - name
        - field

    Aggregation:
      type: object
      properties:
        name:
          type: string
          description: Aggregation name
        items:
          type: array
          items:
            $ref: '#/components/schemas/AggregationItem'
        other_count:
          type: integer
          description: Count of the documents not included in the items

    AggregationItem:
      type: object
      properties:
        key:
          type: string
          description: Aggregation key
        count:
          type: integer
          description: Aggregation count
        aggregations:
          type: array
          minItems: 0
          maxItems: 100
          items:
            $ref: '#/components/schemas/Aggregation'

    Attribute:
      type: object
      properties:
        name:
          type: string
          description: Name of the attribute.
        value:
          description: Value of the attribute.
        scope:
          type: string
          description: The scope the attribute belongs to.
        description:
          type: string
          description: Optional attributes description.
      required:
        - name
        - value

    DeviceInventory:
      type: object
      properties:
        id:
          type: string
          description: Device ID.
        attributes:
          type: array
          items:
            $ref: '#/components/schemas/Attribute'
        updated_ts:
          type: string
          format: date-time
          description: >-
            Timestamp of the last update to the device attributes.

    FilterAttribute:
      description: Filterable attribute
      type: object
      required:
        - scope
        - name
        - count
      properties:
        name:
          type: string
          description: Name of the attribute.
        scope:
          type: string
          description: Scope of the attribute.
        count:
          type: integer
          description: Number of occurrences of the attribute in the database.
      example:
        name: "serial_no"
        scope: "inventory"
        count: 10

    FilterTerm:
      type: object
      properties:
        attribute:
          type: string
          description: Attribute key to compare.
        value:
          description: Filter matching expression.
        type:
          type: string
          enum:
            - "$eq"
            - "$gt"
            - "$gte"
            - "$in"
            - "$lt"
            - "$lte"
            - "$ne"
            - "$nin"
            - "$exists"
            - "$regex"
          description: Type of filtering operation.
        scope:
          type: string
          description: The scope the attribute exists in.
      required:
        - attribute
        - type
        - value

    SortTerm:
      type: object
      properties:
        attribute:
          type: string
          description: Attribute key to sort by.
        scope:
          type: string
          description: Scope the attribute key belongs to.
        order:
          type: string
          enum:
            - asc
            - desc
          description: "Sort order: ascending/descending."
      required:
        - attribute
        - order

    AttributeProjection:
      type: object
      properties:
        attribute:
          type: string
          description: Attribute key to sort by.
        scope:
          type: string
          description: Scope the attribute key belongs to.
      required:
        - attribute

    AggregationTerms:
      type: object
      properties:
        aggregations:
          type: array
          items:
            $ref: '#/components/schemas/AggregationTerm'
          description: Aggregation terms.
        filters:
          type: array
          items:
            $ref: '#/components/schemas/FilterTerm'
          description: Filtering terms.

    SearchTerms:
      type: object
      properties:
        page:
          type: integer
          description: Pagination parameter for iterating search results.
        per_page:
          type: integer
          description: Number of devices returned per page.
        filters:
          type: array
          items:
            $ref: '#/components/schemas/FilterTerm'
          description: Filtering terms.
        sort:
          type: array
          items:
            $ref: '#/components/schemas/SortTerm'
          description: Attribute keys to sort by.
        attributes:
          type: array
          items:
            $ref: '#/components/schemas/AttributeProjection'
          description: Restrict the attribute result to the selected attributes.
        device_ids:
          type: array
          items:
            type: string
          description: Restrict the result to the given device IDs.

  responses:
    InternalServerError:
      description: Internal Server Error.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "internal error"
            request_id: "eed14d55-d996-42cd-8248-e806663810a8"

    InvalidRequestError:
      description: Invalid Request.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "bad request parameters"
            request_id: "eed14d55-d996-42cd-8248-e806663810a8"
